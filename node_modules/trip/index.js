/**
 * trip module
 */

var express = require('express');
var tripManager = require('./trip-manager');

var tripRouter = express.Router();

tripRouter.use(function timeLog(req, res, next) {
  console.log('Received request :', Date.now());
  next();
});

tripRouter.get('/', function(req, res) {
  res.send('Trip home page!');
});

tripRouter.get('/getTrip', function(req, res) {

  var tripId = req.query.tripId;
  var tripInfo = tripManager.getTrip(tripId);

  streamContent(res, tripInfo);
});

tripRouter.get('/getInstruction', function(req, res) {
  var instructionId = req.query.instructionId;
  var instructionInfo = tripManager.getInstruction(instructionId);

  streamContent(res, instructionInfo);
})

function streamContent(res, streamInfo) {
  res.writeHead(200, {
    'Content-Type' : streamInfo.contentInfo,
    'Content-Length' : streamInfo.stat.size
  });

  var stream = streamInfo.stream;

  stream.on('open', function() {
    stream.pipe(res);
  });

  stream.on('error', function(err) {
    res.end(err);
  });
}

module.exports = tripRouter;

